<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å¹³è³‡ç”¢è¡¨ï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; padding:16px; max-width:760px; margin:0 auto;}
    h1{font-size:24px; margin:8px 0 16px;}
    h2{font-size:18px; margin:18px 0 8px;}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:10px 0;}
    .row{display:flex; gap:8px; flex-wrap:wrap;}
    input,select,button{font-size:16px; padding:10px; border-radius:10px; border:1px solid #d1d5db;}
    input,select{flex:1; min-width:120px;}
    button{background:#111827; color:#fff; border:none; padding:10px 14px;}
    .btn2{background:#374151;}
    table{width:100%; border-collapse:collapse; font-size:14px;}
    th,td{border-bottom:1px solid #eee; padding:8px; text-align:right;}
    th:first-child, td:first-child{text-align:left;}
    .muted{color:#6b7280; font-size:13px;}
    .ok{color:#059669;}
    .bad{color:#dc2626;}
  </style>
</head>
<body>
  <h1>ğŸ“Š å¹³è³‡ç”¢è¡¨ï¼ˆå®Œæ•´ç‰ˆ MVPï¼‰</h1>
  <div class="muted">å¤šæª”æŠ•è³‡ + å¤šç­†å€Ÿè²¸ + è³‡ç”¢è² å‚µç¸½è¦½ï¼ˆiPhone ç›´æ¥ç”¨ï¼‰</div>

  <div class="card">
    <h2>â‘  æŠ•è³‡ï¼ˆå¯æ–°å¢å¤šç­†ï¼‰</h2>
    <div id="holdings"></div>
    <div class="row">
      <button onclick="addHolding()">ï¼‹æ–°å¢ä¸€ç­†æŠ•è³‡</button>
      <button class="btn2" onclick="saveLocal()">å„²å­˜ï¼ˆæœ¬æ©Ÿï¼‰</button>
      <button class="btn2" onclick="loadLocal()">è®€å–ï¼ˆæœ¬æ©Ÿï¼‰</button>
    </div>
    <div class="muted">æç¤ºï¼šå°è‚¡ ETF ä»£è™Ÿè«‹ç”¨ <b>00713.TW</b>ã€<b>00937B.TW</b> é€™ç¨®æ ¼å¼ã€‚</div>
  </div>

  <div class="card">
    <h2>â‘¡ ä¸é™ç”¨é€”å€Ÿè²¸ï¼ˆå¯æ–°å¢å¤šç­†ï¼‰</h2>
    <div id="loans"></div>
    <button onclick="addLoan()">ï¼‹æ–°å¢ä¸€ç­†å€Ÿè²¸</button>
    <div class="muted">åˆ©ç‡è«‹å¡«å¹´åˆ©ç‡ï¼ˆ%ï¼‰ã€‚ä¾‹å¦‚ 2.3 ä»£è¡¨ 2.3%</div>
  </div>

  <div class="card">
    <h2>â‘¢ ç”¢ç”Ÿè³‡ç”¢è² å‚µè¡¨</h2>
    <button onclick="calc()">è¨ˆç®— / æ›´æ–°</button>
    <div id="summary" style="margin-top:12px;"></div>
  </div>

  <div class="card">
    <h2>æŠ•è³‡æ˜ç´°</h2>
    <div id="investTable"></div>
  </div>

  <div class="card">
    <h2>å€Ÿè²¸æ˜ç´°</h2>
    <div id="loanTable"></div>
  </div>

<script>
  function holdingRow(data={}){
    const id = crypto.randomUUID();
    const symbol = data.symbol || "00713.TW";
    const name = data.name || "";
    const unit = data.unit || "lots";
    const qty = (data.qty ?? 22);
    const cost = (data.cost ?? 50);

    return `
      <div class="card" data-type="holding" data-id="${id}">
        <div class="row">
          <input placeholder="ä»£è™Ÿ ä¾‹ 00713.TW" value="${symbol}" data-k="symbol"/>
          <input placeholder="åç¨±ï¼ˆå¯ç•™ç©ºï¼‰" value="${name}" data-k="name"/>
        </div>
        <div class="row" style="margin-top:8px;">
          <select data-k="unit">
            <option value="lots" ${unit==="lots"?"selected":""}>å¼µ</option>
            <option value="shares" ${unit==="shares"?"selected":""}>è‚¡</option>
          </select>
          <input type="number" inputmode="decimal" placeholder="æ•¸é‡" value="${qty}" data-k="qty"/>
          <input type="number" inputmode="decimal" placeholder="æˆæœ¬(æ¯è‚¡)" value="${cost}" data-k="cost"/>
          <button class="btn2" onclick="removeRow(this)">åˆªé™¤</button>
        </div>
        <div class="muted">è‹¥é¸ã€Œå¼µã€ï¼Œç³»çµ±æœƒè‡ªå‹• Ã—1000 è½‰è‚¡æ•¸ã€‚</div>
      </div>
    `;
  }

  function loanRow(data={}){
    const id = crypto.randomUUID();
    const name = data.name || "å°è‚¡å€Ÿè²¸";
    const principal = (data.principal ?? 0);
    const rate = (data.rate ?? 2.0);

    return `
      <div class="card" data-type="loan" data-id="${id}">
        <div class="row">
          <input placeholder="å€Ÿè²¸åç¨±" value="${name}" data-k="name"/>
          <input type="number" inputmode="decimal" placeholder="æœ¬é‡‘" value="${principal}" data-k="principal"/>
          <input type="number" inputmode="decimal" placeholder="å¹´åˆ©ç‡(%)" value="${rate}" data-k="rate"/>
          <button class="btn2" onclick="removeRow(this)">åˆªé™¤</button>
        </div>
      </div>
    `;
  }

  function addHolding(){ document.getElementById("holdings").insertAdjacentHTML("beforeend", holdingRow()); }
  function addLoan(){ document.getElementById("loans").insertAdjacentHTML("beforeend", loanRow()); }
  function removeRow(btn){ btn.closest(".card").remove(); }

  function collect(type){
    const cards = [...document.querySelectorAll(`[data-type="${type}"]`)];
    return cards.map(card=>{
      const obj = {};
      card.querySelectorAll("[data-k]").forEach(el=>{
        obj[el.getAttribute("data-k")] = el.value;
      });
      if(type==="holding"){
        obj.qty = Number(obj.qty || 0);
        obj.cost = Number(obj.cost || 0);
      } else {
        obj.principal = Number(obj.principal || 0);
        obj.rate = Number(obj.rate || 0);
      }
      return obj;
    });
  }

  async function calc(){
    const holdings = collect("holding");
    const loans = collect("loan");

    const res = await fetch("/api/portfolio", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({holdings, loans})
    });

    const data = await res.json();

    if(!res.ok){
      document.getElementById("summary").innerHTML =
        `<div class="bad"><b>ç™¼ç”ŸéŒ¯èª¤ï¼š</b>${(data && (data.error||data.message)) || "è«‹ç¨å¾Œå†è©¦"}</div>`;
      return;
    }

    const t = data.totals;
    document.getElementById("summary").innerHTML = `
      <div><b>æŠ•è³‡æˆæœ¬ç¸½é¡ï¼š</b>${t.invest_cost_total.toLocaleString()}</div>
      <div><b>æŠ•è³‡å¸‚å€¼ç¸½é¡ï¼š</b>${t.invest_market_value_total.toLocaleString()}</div>
      <div><b>å€Ÿè²¸æœ¬é‡‘ç¸½é¡ï¼š</b>${t.loan_principal_total.toLocaleString()}</div>
      <div><b>å€Ÿè²¸æ¯æœˆåˆ©æ¯ï¼š</b>${t.loan_monthly_interest_total.toLocaleString()}</div>
      <div style="margin-top:8px;font-size:18px;">
        <b>æ·¨å€¼ï¼ˆæŠ•è³‡å¸‚å€¼ - å€Ÿè²¸æœ¬é‡‘ï¼‰ï¼š</b>
        <span class="${t.net_worth>=0?'ok':'bad'}">${t.net_worth.toLocaleString()}</span>
      </div>
    `;

    const inv = data.invest || [];
    document.getElementById("investTable").innerHTML = tableHTML(
      ["ä»£è™Ÿ","åç¨±","è‚¡æ•¸","æˆæœ¬","ç¾åƒ¹","æˆæœ¬ç¸½é¡","å¸‚å€¼","æœªå¯¦ç¾","å ±é…¬%"],
      inv.map(r=>[
        r.symbol, r.name || "",
        num(r.shares), num(r.cost), num(r.price),
        num(r.cost_total), num(r.market_value), num(r.unrealized_pl),
        num(r.return_pct)
      ])
    );

    const ln = data.loans || [];
    document.getElementById("loanTable").innerHTML = tableHTML(
      ["åç¨±","æœ¬é‡‘","å¹´åˆ©ç‡%","æœˆåˆ©æ¯","å¹´åˆ©æ¯"],
      ln.map(r=>[
        r.name, num(r.principal), num(r.rate),
        num(r.monthly_interest), num(r.annual_interest)
      ])
    );
  }

  function num(x){
    if (x===null || x===undefined) return "";
    if (typeof x === "number") return x.toLocaleString();
    const n = Number(x);
    return isNaN(n) ? String(x) : n.toLocaleString();
  }

  function tableHTML(headers, rows){
    let h = "<table><thead><tr>";
    headers.forEach(c=> h += `<th>${c}</th>`);
    h += "</tr></thead><tbody>";
    rows.forEach(r=>{
      h += "<tr>";
      r.forEach(c=> h += `<td>${c}</td>`);
      h += "</tr>";
    });
    h += "</tbody></table>";
    return h;
  }

  function saveLocal(){
    const data = { holdings: collect("holding"), loans: collect("loan") };
    localStorage.setItem("ping_asset_state", JSON.stringify(data));
    alert("å·²å„²å­˜åˆ°æœ¬æ©Ÿï¼ˆæ­¤æ‰‹æ©Ÿç€è¦½å™¨ï¼‰");
  }
  function loadLocal(){
    const raw = localStorage.getItem("ping_asset_state");
    if(!raw){ alert("æœ¬æ©Ÿæ²’æœ‰è³‡æ–™"); return; }
    const data = JSON.parse(raw);
    document.getElementById("holdings").innerHTML = "";
    document.getElementById("loans").innerHTML = "";
    (data.holdings||[]).forEach(h=> document.getElementById("holdings").insertAdjacentHTML("beforeend", holdingRow(h)));
    (data.loans||[]).forEach(l=> document.getElementById("loans").insertAdjacentHTML("beforeend", loanRow(l)));
    alert("å·²è®€å–æœ¬æ©Ÿè³‡æ–™");
  }

  // init
  addHolding();
  addLoan();
</script>
</body>
</html>
